##snb

stages:
  - build
  - deploy

build_backend_prod:
  only:
    - deploy
  stage: build
  script:
    - docker build -t registry.gitlab.com/opensi/snb-front:prod  ./backend
    - docker push registry.gitlab.com/opensi/snb-back
  tags:
    - shell-1
  environment:
    name: production

build_frontend_page_prod:
  only:
    - deploy
  stage: build
  script:
    - cp front/.env ./frontend/.env
    - docker build -t registry.gitlab.com/opensi/snb-front:prod  ./front
    - docker push registry.gitlab.com/opensi/snb-front
  tags:
    - shell-1
  environment:
    name: production

deploy_dev_images_prod:
  stage: deploy
  tags:
    - shell-1
  only:
    - prod
  #before_script:
  #  - docker login https://eu.gcr.io
  script:
    - docker-compose -f docker-compose.yml pull
    - docker-compose -f docker-compose.yml up -d --force-recreate
