# .gitlab-ci.yml

# Set the stages for the pipeline
stages:
  - build
  - deploy

# Define the services used in the pipeline
services:
  - docker:dind

# Define the jobs for the pipeline
build_backend_prod:
  stage: build
  only:
    refs:
      - deploy
    changes:
      - backend/**/*
      - .gitlab-ci.yml
  script:
    - docker build -t registry.gitlab.com/opensi/snb-backend:prod -f backend/Dockerfile .
    - docker push registry.gitlab.com/opensi/snb-backend:prod
  tags:
    - shell-1

build_frontend_prod:
  stage: build
  only:
    refs:
      - deploy
    changes:
      - frontend/**/*
      - .gitlab-ci.yml
  script:
    - docker build -t registry.gitlab.com/opensi/snb-front:prod -f front/Dockerfile .
    - docker push registry.gitlab.com/opensi/snb-front:prod
  tags:
    - shell-1

deploy_prod:
  stage: deploy
  tags:
    - shell-1
  only:
    refs:
      - deploy
  script:
    - docker-compose -f docker-compose.yml pull
    - docker-compose -f docker-compose.yml up -d --force-recreate
  environment:
    name: production
  when: manual
