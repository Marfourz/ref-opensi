##snb

variables:
  REGISTRY: "registry.gitlab.com"
  DOCKER_REGISTRY: registry.gitlab.com

stages:
  - build
  - deploy

before_script:
  - sudo docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $DOCKER_REGISTRY

build_backend_prod:
  only:
    - deploy
  stage: build
  script:
    - docker build -t registry.gitlab.com/opensi/snb-backend:staging  ./backend
    - sudo docker push registry.gitlab.com/opensi/snb-backend:staging
  tags:
    - shell-1
  environment:
    name: development

build_frontend_page_staging:
  only:
    - deploy
  stage: build
  script:
    - echo "VITE_APP_API_URL=http://api-snb.opensi.co" >> .env
    - docker build --no-cache -t registry.gitlab.com/opensi/snb-frontend:staging  ./front
    - sudo docker push registry.gitlab.com/opensi/snb-frontend:staging
  tags:
    - Shell-1
  environment:
    name: development

deploy_dev_images_staging:
  stage: deploy
  tags:
    - Shell-1
  only:
    - deploy
  script:
    - sudo docker push registry.gitlab.com/opensi/users-manager
    - docker-compose -f docker-compose.yml pull
    - docker-compose -f docker-compose.yml up -d --force-recreate
